<div class="header-top d-flex align-items-center justify-content-between p-3">
  <div class="title-container d-flex align-items-center">
    <h5 class="mb-0">Clients</h5>
    <button class="btn btn-sm btn-light ms-3" (click)="loadClient()"><i class="fas fa-redo"></i></button>
  </div>

  <div class="actions-container d-flex align-items-center">
   <div class="d-flex mb-3" style="margin-right: 25px;">
  <input type="text" class="form-control me-2" placeholder="Search name/email" [formControl]="filter">

  <select class="form-select me-2" [formControl]="statusFilter">
    <option value="">All Status</option>
    <option *ngFor="let s of statusList" [value]="s">{{ s }}</option>
  </select>

  <select class="form-select me-2" [formControl]="designationFilter">
    <option value="">All Positions</option>
    <option *ngFor="let d of designationList" [value]="d">{{ d }}</option>
  </select>
</div>


    <button class="btn btn-primary" (click)="onAdd()" style="background-color: #745af3;margin-top: -15px;">
      <i class="fas fa-plus"></i>
    </button>
  </div>
</div>

<div class="table-responsive">
  <table class="table client-table">
    <thead>
      <tr>
        <th>NAME</th>
        <th>POSITION</th>
        <th>MAIL</th>
        <th>MOBILE</th>
        <th>STATUS</th>
        <th>ACTIONS</th>
      </tr>
    </thead>
    
   <tbody>
  
    <tr *ngFor="let client of filteredClients$ | async; let i = index">
      <td>
        <div class="d-flex align-items-center">
          <img *ngIf="client.profilePic; else defaultAvatar" 
               class="profile-pic rounded-circle me-2"
               [src]="client.profilePic" 
               alt="{{ client.name }}" 
               style="width:40px; height:40px; object-fit:cover;" />
          <ng-template #defaultAvatar>
            <div class="profile-pic rounded-circle me-2 d-flex align-items-center justify-content-center"
                 style="width:40px; height:40px; background:#e0e0e0;">
              <i class="fas fa-user text-muted"></i>
            </div>
          </ng-template>
          <div>{{ client.fullName || client.name }}</div>
        </div>
      </td>
      <td>{{ client.designation }}</td>
      <td><a [href]="'mailto:' + client.email">{{ client.email }}</a></td>
      <td>{{ client.phone }}</td>
      <td>
        <span class="status-dot me-1" [ngClass]="{
          'status-active': client.status === 'Active',
          'status-inactive': client.status === 'Inactive',
          'status-away': client.status?.startsWith('Away'),
          'status-offline': client.status?.startsWith('Offline')
        }"></span>
        {{ client.status }}
      </td>
      <td class="text-center actions-cell">
        <div class="actions-container" (click)="toggleActions($event)">
          <button class="btn btn-link p-0 ellipsis-icon">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <div class="action-icons" (click)="$event.stopPropagation()">
            <button class="btn btn-link p-0 me-2" (click)="onEdit(client)">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-link p-0" (click)="onDelete(client)">
              <i class="fas fa-trash-alt"></i>
            </button>
            <button class="btn btn-link p-0 ms-2" (click)="onView(client)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
      </td>
    </tr>

</tbody>
  </table>
   <ng-template #isLoading>
         <tr>
            <td colspan="6" class="text-center">Loading...</td>
         </tr>
     </ng-template>
</div>

<div class="modal fade" id="clientModal" tabindex="-1" role="dialog" aria-labelledby="clientModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="width: 850px;height: 1100px;">
      <form [formGroup]="clientForm" (ngSubmit)="saveClient()">
        <div class="modal-header" style="border-bottom: 1px solid #dee2e6;background-color: #f8f9fa;height: 70px;">
          <h5 class="modal-title" id="clientModalLabel">{{ clientForm.get('id')?.value ? 'Edit' : 'Add' }} Client</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fermer" (click)="closeModal()"
            style="object-fit: cover;border: 2px solid #e0e0e0;background-color: transparent; border-color: transparent; margin-left: 714px;display: block;margin-top: -27px;">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" style="margin-top:-39px;">
          <h3>General Information</h3>
          <div class="d-flex align-items-center mt-3">

            <div class="avatar-container me-3" style ="position: relative;display: inline-block;">
              <div class="avatar-preview">

                <img *ngIf="avatarUrl; else defaultAvatar" [src]="avatarUrl" alt="Avatar" class="avatar-img">

                <ng-template #defaultAvatar>
                  <div class="avatar-placeholder">
                    <div class="avatar-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="white" viewBox="0 0 16 16">
                        <path d="M10.5 3a.5.5 0 0 0-.5.5V4H6v-.5a.5.5 0 0 
                                 0-1 0V4H3a2 2 0 0 0-2 2v6a2 2 0 0 0 
                                 2 2h10a2 2 0 0 0 2-2V6a2 2 0 0 
                                 0-2-2h-2V3.5a.5.5 0 0 
                                 0-.5-.5zM8 6a3 3 0 1 1 
                                0 6 3 3 0 0 1 0-6z" />
                        <path d="M8 7a2 2 0 1 0 0 4 2 2 0 0 0 0-4z" />
                      </svg>
                    </div>
                  </div>
                </ng-template>

              </div>
             

            <div style="margin-bottom: 25px; margin-top: -50px;margin-left: 95px;"  [class.disabled-section]="isViewMode">
               <label class="btn btn-primary btn-sm me-2" [class.disabled]="isViewMode">
                  Upload Avatar
                  <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" hidden  [disabled]="isViewMode">
                </label>
                <a href="javascript:void(0)" class="text-primary" (click)="clearAvatar(fileInput)"[class.disabled]="isViewMode"
                  [style.pointer-events]="isViewMode ? 'none' : 'auto'" >Clear selected
                  Image</a>
        
              <div class="text-muted small" style="margin-top: -7px;margin-bottom: -2px;margin-left:117px;">
                Please upload a .jpg or .png file with a minimum dimension of 400x400 not
                exceeding 5MB
              </div>
            </div>
                <div class="col-md-4 col-sm-6 col-12">
                 <div class="form-group">
                    <input type="hidden" class="form-control" formControlName="id" readonly />
                   </div>
                  </div>
               <div class="row">
                
              <div class="col-md-4 col-sm-6 col-12">
                 <div class="form-group">
                   <label for="name">First Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="name" />
                    <div *ngIf="clientForm.get('name')?.invalid && (clientForm.get('name')?.touched || clientForm.get('name')?.dirty)" class="text-danger mt-1">
                         <small>The first name is required.</small>
                      </div>
                   </div>
                 </div>
               <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label for="lastName">Last Name <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" formControlName="lastName" />
                      <div *ngIf="clientForm.get('lastName')?.invalid && (clientForm.get('lastName')?.touched || clientForm.get('lastName')?.dirty)" class="text-danger mt-1">
                         <small>The last name is required.</small>
                      </div>
                    </div>
                 </div>
                  <div class="col-md-4 col-sm-6 col-12">
                 <div class="form-group">
                 <label >Full Name </label>
                   <input type="text" class="form-control" formControlName="fullName"
                      readonly />
                   </div>
                 </div>
               </div>

              <div class="row" style="margin-top:17px;">
              
                 <div class="col-md-4 col-sm-6 col-12">
                 <div class="form-group">
            
                     <label for="dateOfBirth">Date of Brith<span class="text-danger">*</span></label>
                    <input type="date" class="form-control" formControlName="dateOfBirth" />
                       <div *ngIf="clientForm.get('dateOfBirth')?.touched && clientForm.get('dateOfBirth')?.invalid" class="text-danger mt-1">
                          <small *ngIf="clientForm.get('dateOfBirth')?.errors?.['futureDate']">
                                 The date of birth cannot be in the future.
                          </small>
                        </div>

                  </div>
                 </div>
                <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-group">
                   <label for="designation">Designation <span class="text-danger">*</span></label>
                      <select class="form-select" formControlName="designation">
                          <option value="">-- Select Designation --</option>
                          <option *ngFor="let d of designationList" [value]="d">{{ d }}</option>
                      </select>
                      <div *ngIf="clientForm.get('designation')?.invalid && (clientForm.get('designation')?.touched || clientForm.get('designation')?.dirty)"
                        class="text-danger mt-1">
                         <small>The designation is required.</small>
                      </div>
                   </div>
               </div>
                <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label for="status" style="margin-left: 10px;">Status <span class="text-danger">*</span></label>
                     <select class="form-select" formControlName="status" style="height: 39px; margin-left: 2px; width: 240px;">
                        <option value="">-- Select Status --</option>
                         <option *ngFor="let s of statusList" [value]="s">
                           <span class="status-dot me-1" [ngClass]="{
                                      'status-active': s === 'Active',
                                      'status-inactive': s === 'Inactive',
                                      'status-away': s === 'Away',
                                      'status-offline': s === 'Offline'
                               }"></span>{{ s }}
                         </option>

                     </select>
              
                    <div *ngIf="clientForm.get('status')?.invalid && (clientForm.get('status')?.touched || clientForm.get('status')?.dirty)"
                         class="text-danger mt-1">
                       <small>Le statut est obligatoire.</small>
                     </div>
                    </div>
                  </div>
                <div class="col-md-4 col-sm-6 col-12" style="margin-top: -1px;">
                   <div class="form-group">
                      <label for="email">Email <span class="text-danger">*</span></label>
                     <input type="email" class="form-control" formControlName="email"
                      placeholder="Enter email"  style="width :300px;"/>
                    <div
                      *ngIf="clientForm.get('email')?.invalid && (clientForm.get('email')?.dirty || clientForm.get('email')?.touched)"
                      class="text-danger mt-1">
                     <small *ngIf="clientForm.get('email')?.errors?.['required']">
                         L'email est obligatoire.
                         </small>
                     <small *ngIf="clientForm.get('email')?.errors?.['email']">
                        Veuillez saisir un email valide.
                       </small>
                     </div>
                   </div>
                </div>
               
                </div>

              <h3>Contact Information</h3>
              <div class="row">
                <div class="col-md-4 col-sm-6 col-12">
                   <div class="form-group">
                     <label for="address">Address <span class="text-danger">*</span></label>
                       <input type="text" class="form-control" formControlName="address" style="width :250px;"/>
                        <div *ngIf="clientForm.get('address')?.invalid && (clientForm.get('address')?.touched || clientForm.get('address')?.dirty)" class="text-danger mt-1">
                          <small>Address is required.</small>
                       </div>
                   </div>
                  </div>
                  <div class="col-md-4 col-sm-6 col-12">
                   <div class="form-group">
                     <label style="margin-left: 9px;" for="country">Country<span class="text-danger">*</span></label>
                         <select class="form-select" formControlName="country" style="margin-left: 5px; width: 241px;height: 42px;">
                            <option value="">-- Select Country --</option>
                             <option *ngFor="let c of countries" [value]="c.name.common || c.name">{{ c.name.common || c.name }}</option>

                         </select>
                          <div *ngIf="clientForm.get('country')?.invalid && (clientForm.get('country')?.touched || clientForm.get('country')?.dirty)" class="text-danger mt-1" style="margin-left: 5px;">
                              <small>The country is required.</small>
                          </div>
                   </div>
               </div>
                 <div class="col-md-4 col-sm-6 col-12">
                   <div class="form-group">
                     <label style="margin-left: 8px;" for="city">City<span class="text-danger">*</span></label>
                         <input type="text" class="form-control" formControlName="city" style="margin-left:12 px;" />
                          <div *ngIf="clientForm.get('city')?.invalid && (clientForm.get('city')?.touched || clientForm.get('city')?.dirty)" class="text-danger mt-1" style="margin-left: 12px;">
                            <small>The city is required.</small>
                          </div>
                    </div>
                   </div>
                 <div class="col-md-4 col-sm-6 col-12">
                   <div class="form-group">
                     <label style="margin-left: 3px;" for="province">Province <span class="text-danger">*</span></label>
                       <input type="text" class="form-control" formControlName="province" style="margin-left: 4px; width: 249px;height: 42px;"/>
                        <div *ngIf="clientForm.get('province')?.invalid && (clientForm.get('province')?.touched || clientForm.get('province')?.dirty)" class="text-danger mt-1" style="margin-left: 4px;">
                          <small>the province is required..</small>
                        </div>
                      </div>
                 </div>
               
              
                  <div class="col-md-4 col-sm-6 col-12">
                   <div class="form-group">
                       <label style="margin-left: 11px;" for="postalCode">Postal Code <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" formControlName="postalCode" style="width: 241px;margin-left: 5px;"/>
                      <div *ngIf="clientForm.get('postalCode')?.invalid && (clientForm.get('postalCode')?.touched || clientForm.get('postalCode')?.dirty)" class="text-danger mt-1" style="margin-left: 5px;">
                              <small>The postal code is required.</small>
                           </div>
                      </div>
                   </div>
                  <div class="col-md-4 col-sm-6 col-12">
            <div class="form-group">
               <label for="phone" style="margin-left: 7px;">Phone <span class="text-danger">*</span></label>
               <input type="text" formControlName="phone" class="form-control" 
                      placeholder="Enter phone number" style=" width: 100%;" />

               <div *ngIf="clientForm.get('phone')?.invalid && (clientForm.get('phone')?.dirty || clientForm.get('phone')?.touched)"
                 class="text-danger mt-1" style="margin-left: 58px;">
                  <small *ngIf="clientForm.get('phone')?.errors?.['required']">
                   Le numéro de téléphone est obligatoire.
                  </small>
                  <small *ngIf="clientForm.get('phone')?.errors?.['pattern']">
                 Le format du numéro de téléphone n'est pas valide.
              </small>
        </div>
       </div>
     </div>
    </div>
                 
     


             <h3>Employment Information</h3>
              <div class="row">
                 <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-group">
                        <label for="jobTitle">Job Title / Occupation <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" formControlName="jobTitle" />
                        <div *ngIf="clientForm.get('jobTitle')?.invalid && clientForm.get('jobTitle')?.touched" class="text-danger">
                           <small>The job title is required</small>
                         </div>
                    </div>
                  </div>
                <div class="col-md-4 col-sm-6 col-12">
                   <div class="form-group">
                     <label for="hireDate">Date of Hire <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" formControlName="hireDate" />

                    </div>
                  </div>
                 <div class="col-md-4 col-sm-6 col-12">
                   <div class="form-group">
                    <label for="workReferenceNumber">Work Reference Number <span class="text-danger">*</span></label>
                     <input type="text" class="form-control" formControlName="workReferenceNumber" />
                     <div *ngIf="clientForm.get('workReferenceNumber')?.invalid && clientForm.get('workReferenceNumber')?.touched" class="text-danger">
                           <small>The work Reference Number is required</small>
                         </div>
                    </div>
                  </div>
               <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label for="occupationGroup">Occupation Group <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="occupationGroup" />
                    <div *ngIf="clientForm.get('occupationGroup')?.invalid && clientForm.get('occupationGroup')?.touched" class="text-danger">
                           <small>The occupation group is required</small>
                         </div>
                   </div>
                 </div>
                <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-group">
                      <label for="department">Department <span class="text-danger">*</span></label>
                        <select class="form-select" formControlName="department">
                          <option value="">-- Select Department --</option>
                          <option *ngFor="let dept of departmentList" [value]="dept">{{ dept }}</option>
                        </select>
                         <div *ngIf="clientForm.get('department')?.invalid && clientForm.get('department')?.touched" class="text-danger">
                           <small>The department  is required</small>
                         </div>
                  </div>
                  </div>
                 <div class="col-md-4 col-sm-6 col-12">
                  <div class="form-group">
                     <label for="division">Division <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="division" />
                         <div *ngIf="clientForm.get('division')?.invalid && clientForm.get('division')?.touched" class="text-danger">
                           <small>The division  is required</small>
                         </div>
                     </div>
                  </div>
              </div>
           </div>
      </div>
          
   </div>
      <div class="modal-footer" style="border-top: 1px solid #dee2e6;background-color: #f8f9fa; padding: 1rem;margin-top: -35px;">
                <button type="button" class="btn btn-secondary" (click)="closeModal()"
                  style="margin-top: -2px">{{ isViewMode ? 'Close' : 'Cancel' }}</button>
                <button type="submit" class="btn btn-primary" [disabled]="isSaving" *ngIf ="!isViewMode"
                  style="margin-top: -2px"> {{ isSaving ? 'Saving…' : 'Save' }}</button>
                  
        </div>

      </form>
    </div>
  </div>
</div>