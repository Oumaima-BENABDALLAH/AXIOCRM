<div class="header-top d-flex align-items-center justify-content-between p-3">
  <!-- Titre + bouton refresh -->
  <div class="title-container d-flex align-items-center">
    <h5 class="mb-0">Orders</h5>
    <button class="btn btn-sm btn-light ms-3" (click)="loadOrders()">
      <i class="fas fa-redo"></i>
    </button>
  </div>

  <!-- Actions (recherche + ajout) -->
  <div class="actions-container d-flex align-items-center">
    <div class="d-flex mb-3" style="margin-top:19px;">
      <input
        type="text"
        class="form-control me-2"
        placeholder="Search ...."
        [formControl]="filter"
      />
    </div>
  <button class="btn btn-primary me-2"
        (click)="onAddInvoice(selectedOrder)"
        [disabled]="!selectedOrder">
  <i class="fas fa-file-invoice-dollar"></i> Generate Invoice
</button>
    <button class="btn btn-primary me-2" (click)="onAdd()">
      <i class="fas fa-shopping-cart"></i> Pass an order
    </button>
  </div>
</div>

<!-- Tableau Commandes -->
<div class="table-responsive" style="margin-left: 13px;">
  <table class="table client-table payment-table">
    <thead>
      <tr>
         <th style="width: 40px;">
          <input type="checkbox" (change)="toggleSelectAll($event)">
        </th>
        <th>Date</th>
        <th>Client</th>
        <th>Payment Method</th>
        <th>Total Amount (€)</th>
        <th>Products</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let order of filteredOrders$ | async"
       (click)="selectOrder(order)"
       [ngClass]="{ 'selected-row': selectedOrder?.id === order.id }">
        <td>
          <input type="checkbox"
             [checked]="selectedOrder?.id === order.id"
             (change)="toggleRowSelection(order, $event)">
        </td>  
        <td>{{ order.orderDate | date: 'dd/MM/yyyy' }}</td>
       <td>{{ order.client?.name + ' ' + order.client?.lastName }}</td>
        <td>{{ order.paymentMethod }}</td>
       <td>{{ order.cashAmount | currency:'USD'  }}</td>
        <td>
          <ul *ngIf="order.orderProducts?.length > 0; else aucunProduit" class="m-0 p-0">
            <li *ngFor="let p of order.orderProducts">
              {{ p.productName || ('Produit #' + p.productId) }}
            </li>
          </ul>
          <ng-template #aucunProduit>
            <span class="text-muted">Aucun produit</span>
          </ng-template>
        </td>

        <!-- Actions -->
        <td class="text-center actions-cell">
          <div class="actions-container" (click)="toggleActions($event)">
            <button class="btn btn-link p-0 ellipsis-icon">
              <i class="fas fa-ellipsis-v"></i>
            </button>

            <div class="action-icons" (click)="$event.stopPropagation()">
              <button class="btn btn-link p-0 me-2"
                  (click)="onEdit(order); $event.stopPropagation()">
                  <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-link p-0" (click)="onDelete(order)">
                <i class="fas fa-trash-alt"></i>
              </button>
              <button class="btn btn-link p-0 ms-2" (click)="onView(order)">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- ======================================== -->
<!-- MODAL Ajouter / Modifier / Détail Commande -->
<!-- ======================================== -->
<!-- ======================================== -->
<!-- MODAL Ajouter / Modifier / Détail Commande -->
<!-- ======================================== -->
<div class="modal fade" id="orderModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-3">

      <!-- HEADER -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          {{ isViewMode ? 'Order Details' : 'Add / Edit Order' }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body" [formGroup]="orderForm">

        <div class="row">

          <!-- ========================= -->
          <!-- LEFT COLUMN – CLIENT INFO -->
          <!-- ========================= -->
          <div class="col-lg-7" style="width: 48.333333%;">

            <div class="card shadow-sm mb-4">
              <div class="card-body">
                
                <h5 class="fw-bold mb-3">
                  <i class="fas fa-user me-2 text-primary"></i> Contact Information
                </h5>

                <!-- SELECT CLIENT -->
                  <div class="full">
                      <label  class="form-label">Order Date</label>
                      <input type="date" class="form-control" formControlName="orderDate">
                  </div>
                <div class="col-md-12">
                   
                  <label class="form-label">Client</label>
                  <select class="form-select"
                          formControlName="clientId"
                          (change)="onClientChange($event)">
                    <option value="">-- Select client --</option>
                    <option *ngFor="let c of clients" [value]="c.id">
                      {{ c.name }} {{ c.lastName }}
                    </option>
                  </select>
                </div>

                <!-- CLIENT DETAILS -->
             <div *ngIf="showClientDetails" formGroupName="clientInfo" class="mt-3 client-card">

  <div class="client-grid">

      <div class="full">
        <label>Email</label>
        <input type="email" class="form-control" formControlName="email">
      </div>
       <div >
        <label>Address</label>
        <input type="text" class="form-control" formControlName="address">
      </div>
       <div>
         <label>Country</label>
         <input type="text" class="form-control" formControlName="country">
       </div>
    

   
      <div>
        <label>City</label>
        <input type="text" class="form-control" formControlName="city">
      </div>

      <div>
        <label>Province</label>
        <input type="text" class="form-control" formControlName="province">
      </div>

   

      <div>
        <label>Postal Code</label>
        <input type="text" class="form-control" formControlName="postalCode">
      </div>

       <div >
        <label>Phone</label>
        <input type="text" class="form-control" formControlName="phone">
      </div>

  </div>

</div>


              </div>
            </div>


            <!-- DELIVERY METHOD -->
            <div class="card shadow-sm mb-4">
              <div class="card-body">

                <h5 class="fw-bold mb-3">
                  <i class="fas fa-truck me-2 text-primary"></i> Delivery Method
                </h5>

                <div class="d-flex gap-3">

                  <div class="card flex-fill border selectable-card"
                       [ngClass]="{ 'border-primary shadow': orderForm.value.deliveryMethod?.name === 'Standard' }"
                       (click)="!isViewMode && selectDeliveryMethod('standard')">
                    <div class="card-body text-center">
                      <h6 class="fw-bold mb-1">Standard Delivery</h6>
                      <p class="text-muted mb-1">(5–6 days)</p>
                      <p class="fw-semibold text-primary">£7.00</p>
                    </div>
                  </div>

                  <div class="card flex-fill border selectable-card"
                       [ngClass]="{ 'border-primary shadow': orderForm.value.deliveryMethod?.name === 'Express' }"
                       (click)="!isViewMode && selectDeliveryMethod('express')">
                    <div class="card-body text-center">
                      <h6 class="fw-bold mb-1">Express Delivery</h6>
                      <p class="text-muted mb-1">(1–2 days)</p>
                      <p class="fw-semibold text-primary">£10.00</p>
                    </div>
                  </div>

                </div>

                <div class="mt-4 row" formGroupName="deliveryMethod">
                  <div class="col-md-4">
                    <label>Name</label>
                    <input class="form-control" formControlName="name" readonly>
                  </div>
                  <div class="col-md-4">
                    <label>Price (£)</label>
                    <input class="form-control" formControlName="price" readonly>
                  </div>
                  <div class="col-md-4">
                    <label>Estimated Days</label>
                    <input class="form-control" formControlName="estimatedDays" readonly>
                  </div>
                </div>

              </div>
            </div>


          

          </div>


          <!-- ============================ -->
          <!-- RIGHT COLUMN – ORDER SUMMARY -->
          <!-- ============================ -->
          <div class="col-lg-5 equal-height" style="width: 575px;">

            <div class="card p-3 shadow-sm h-100">

              <h5 class="fw-bold mb-3">
                <i class="fas fa-box me-2 text-primary"></i> Order Summary
              </h5>

              <button class="btn btn-outline-primary mb-3 w-100"
                      type="button"
                      (click)="openProductSelector()" [disabled]="isViewMode">
                <i class="fas fa-plus"></i> Select Product
              </button>

              <!-- PRODUCTS ARRAY -->
              <div formArrayName="orderProducts">

                <div *ngFor="let p of orderProductsArray.controls; let i = index"
                     [formGroupName]="i"
                     class="d-flex border-bottom pb-3 mb-3">

                  <img [src]="p.value.imageUrl || 'assets/default-product.png'"
                       class="rounded me-3 border"
                       width="80" height="80">

                  <div class="flex-grow-1">

                    <div class="fw-bold">{{ p.value.productName }}</div>
                    <div class="text-muted small">Color: {{ getColorName(p.value.color) }}</div>
                    <div class="fw-bold mt-1">{{ p.value.price | currency:'USD' }}</div>

                    <!-- Quantity -->
                    <div class="d-flex align-items-center mt-2">
                      <button type="button" class="btn btn-sm btn-light" (click)="decreaseQty(i)" [disabled]="isViewMode">−</button>
                      <span class="mx-3">{{ p.value.quantity }}</span>
                      <button type="button" class="btn btn-sm btn-light" (click)="increaseQty(i)" [disabled]="isViewMode">+</button>
                    </div>

                  </div>

                  <button *ngIf="!isViewMode" type="button"
                          class="btn btn-outline-danger btn-sm h-50 align-self-center"
                          (click)="removeProduct(i)" style="margin-top: -65px;">
                        <i class="fas fa-trash"></i>
                  </button>

                </div>

              </div>

              <hr>

              <div class="d-flex justify-content-between fw-bold fs-5">
                <span>Total</span>
                <span class="text-primary">{{ getTotal() | currency:'USD' }}</span>
              </div>
              <!-- DELIVERY COST -->
<div class="d-flex justify-content-between mt-3">
  <span class="fw-semibold">Delivery cost</span>
  <span class="text-dark">
    {{ getDeliveryCost() | currency:'USD' }}
  </span>
</div>

<!-- TOTAL TO PAY --> 
 <div class="d-flex justify-content-between mt-3 fs-5 fw-bold"> 
    <span>Total to pay</span> 
    <span class="text-success"> {{ getTotalToPay() | currency:'USD' }} </span> 
 </div>

 

<!-- CONFIRM BUTTON --
<button class="btn btn-success w-100 mt-4 py-2"
        type="button"
        (click)="openConfirmPopup()">
  Generate Invoice
</button>-->


            </div>
               <!-- PAYMENT METHOD --> 
            <div class="card shadow-sm mb-4">
              <div class="card-body">

                <h5 class="fw-bold mb-3">
                  <i class="fas fa-credit-card me-2 text-primary"></i> Payment Method
                </h5>

                <div class="d-flex gap-4 mb-2">
                  <label>
                    <input type="radio" formControlName="paymentMethod" value="Cash"> Cash
                  </label>
                  <label>
                    <input type="radio" formControlName="paymentMethod" value="Card"> Card
                  </label>
                </div>

               <!-- CASH -->
                <div *ngIf="orderForm.get('paymentMethod')?.value === 'Cash'"
                     class="border rounded p-3 bg-light mt-3">

                  <div class="row">
                    <div class="col-md-6">
                      <label>Cash Amount (€)</label>
                      <input type="number" class="form-control" formControlName="cashAmount">
                    </div>
                    <div class="col-md-6">
                      <label>Payment Date</label>
                      <input type="date" class="form-control" formControlName="paymentDate">
                    </div>
                  </div>

                </div>

                <!-- CARD -->
                <div *ngIf="orderForm.get('paymentMethod')?.value === 'Card'"
                     class="border rounded p-3 bg-light mt-3">

                <!--  Card type: Visa -->
                  <label class="payment-radio mb-3">
                    <input type="radio" formControlName="cardType" value="Visa">
                    <span class="payment-label">
                      Visa <img src="assets/visa.png" class="payment-logo">
                    </span>
                  </label>

                 <!--  Card fields -->
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label>Card Number</label>
                      <input class="form-control" formControlName="cardNumber" placeholder="XXXX-XXXX-XXXX-XXXX">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label>Card Holder</label>
                      <input class="form-control" formControlName="cardHolder"placeholder="John Doe">
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label>Expiry Date</label>
                      <input class="form-control" formControlName="expiryDate"placeholder="MM/YY">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label>CVV</label>
                      <input class="form-control" formControlName="cvv"placeholder="123">
                    </div>
                  </div>
  <div class="payment-option mb-3" style="width: 450px;"> 
  <label class="payment-radio"> 
   <input type="radio" formControlName="cardType" value="MasterCard" />
    <span class="payment-label"> 
      <span class="payment-text">MasterCard</span> 
        <img src="assets/mastercard.png" alt="MasterCard" class="payment-logo" /> 
      </span>
 </label> 
</div>



<div class="payment-option mb-3"style="width: 450px;">
       <label class="payment-radio"> 
         <input type="radio" formControlName="cardType" value="GooglePay" />
          <span class="payment-label"> 
           <span class="payment-text">Google Pay 
           </span> 
           <img src="assets/google-pay.png" alt="Google Pay" class="payment-logo" /> 
         </span>
       </label> 
</div> 

 <div class="payment-option mb-3" style="width: 450px;"> 
   <label class="payment-radio"> 
      <input type="radio" formControlName="cardType" value="PayPal" /> 
     <span class="payment-label"> 
     <span class="payment-text">PayPal</span> 
     <img src="assets/paypal.png" alt="PayPal" class="payment-logo"/> 
    </span> </label> 
 </div> 

                </div>

              </div>
            </div>
          </div>
         
        </div>

      </div>

      <!-- FOOTER -->
      <div class="modal-footer" >
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="onSave()"[disabled]="isViewMode">Save Order</button>
      </div>

    </div>
  </div>
</div>

<div *ngIf="showProductSelector" class="custom-modal">

  <div class="modal-content">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold">Select a Product</h5>
      <button class="btn btn-sm btn-outline-danger" (click)="closeProductSelector()">✖</button>
    </div>

    <!-- Liste des produits disponibles -->
    <button *ngFor="let item of products"
        class="list-group-item list-group-item-action"
        (click)="addProductToOrder(item)">
  <div class="d-flex align-items-center">
    <img [src]="item.imageUrl || 'assets/default-product.png'"
         width="50" class="rounded me-3 border">
    <div class="fw-bold">{{ item.name }}</div>
    <div class="ms-auto text-primary">{{ item.price | currency:'USD' }}</div>
  </div>
</button>

  </div>
</div>
<!-- MODAL CONFIRMATION ORDER 
<div class="modal fade" id="confirmOrderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Confirm Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <h6 class="fw-bold">Client Delivery Information</h6>

        <p><strong>Address:</strong> {{ orderForm.value.clientInfo.address }}</p>
        <p><strong>City:</strong> {{ orderForm.value.clientInfo.city }}</p>
        <p><strong>Province:</strong> {{ orderForm.value.clientInfo.province }}</p>
        <p><strong>Country:</strong> {{ orderForm.value.clientInfo.country }}</p>
        <p><strong>Postal Code:</strong> {{ orderForm.value.clientInfo.postalCode }}</p>

        <hr>

        <p class="fw-bold text-success fs-5">
          Total to Pay: {{ getTotalToPay() | currency:'USD' }}
        </p>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

        <button class="btn btn-success" (click)="confirmFinalOrder()">
          Confirm
        </button>
      </div>

    </div>
  </div>
</div>-->

